//
// TMR_LED : change LED on/off by Timer1 interrupt
//
#include <stdio.h>
#include <stdbool.h>
#include <stdlib.h>
#include <math.h>
#include <string.h>

#include "NUC100Series.h"
#include "MCU_init.h"
#include "SYS_init.h"
#include "SYS.h"
#include "SPI.h"
#include "GPIO.h"	
#include "LCD.h"
#include "Seven_Segment.h"



#include "pokemon.h"

unsigned char	bulb_frame[] = {

  	0xFF,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x81,0x41,0x21,0x91,0x51,0x11,0x21,0x21,0x01,0x19,0x09,0x09,0x09,0x05,0x19,0x07,0x3D,0xC1,0x81,0x01,0x01,0xFF
	, 	0xFF,0x00,0x00,0xC0,0x2C,0x92,0x42,0x82,0x08,0x07,0x24,0x34,0x97,0xC4,0x6C,0x62,0x81,0x01,0x01,0xC2,0x9C,0x30,0x68,0x47,0x00,0x00,0x00,0x81,0x46,0x39,0x06,0xFF
	, 	0xFF,0x38,0x46,0x89,0x8B,0x08,0x0B,0xB9,0xA8,0x28,0x28,0x28,0x29,0x3B,0x4F,0x84,0x84,0x07,0x08,0x00,0x80,0x10,0x8C,0x4E,0x11,0x0F,0x09,0x18,0x28,0xC6,0x03,0xFF
	, 	0xFF,0x80,0x80,0x80,0x80,0x81,0x81,0x81,0x8F,0x81,0x92,0x92,0xA4,0xA4,0xA4,0xA8,0xE8,0x89,0x99,0xC9,0xB8,0x8E,0x91,0x90,0xE0,0xA0,0x80,0x80,0xC0,0xB1,0x8F,0xFF

};
unsigned char	char_frame[] = {
	0xFF,0x6D,0x81,0x03,0x01,0x01,0x01,0x01,0x41,0xE3,0x43,0x49,0x1D,0xF1,0x81,0x01,0xC1,0x83,0x8D,0x3D,0xE9,0x09,0x11,0x21,0xA3,0x23,0x41,0x81,0x01,0x39,0x1D,0xFF
	, 	0xFF,0x09,0x10,0x20,0x20,0x20,0xD0,0x48,0x70,0x38,0x08,0x84,0x40,0x03,0x0F,0x3C,0xE0,0xC1,0x03,0x00,0x1F,0x60,0x80,0x80,0x83,0x8F,0xFE,0xF0,0xC1,0x02,0x04,0xFF
	, 	0xFF,0x18,0x24,0x32,0x22,0x1E,0x61,0x80,0x1C,0x13,0x09,0x10,0x10,0x08,0x7C,0x8E,0x01,0x01,0x03,0x07,0x8E,0x78,0x88,0x84,0x42,0x21,0x10,0x0F,0x03,0x01,0x01,0xFF
	, 	0xFF,0x80,0x80,0x80,0x80,0xE0,0xD0,0x90,0x89,0xC6,0x82,0x82,0xC6,0xCC,0xB4,0x84,0x83,0xBE,0xC2,0x82,0x82,0xC7,0x8C,0x98,0xF0,0xA0,0xC0,0x80,0x80,0x80,0x80,0xFF




};
unsigned char	sqr_frame[] = {
	0xFF,0x01,0xE1,0x11,0xCD,0x83,0x01,0x01,0x01,0x01,0xC1,0x81,0x01,0x03,0x05,0x19,0xE1,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0xFF
	, 	0xFF,0x80,0x83,0x4C,0x50,0x6D,0x3C,0x3C,0xFC,0x2C,0x24,0x21,0x00,0x10,0x48,0x84,0x43,0x64,0xB8,0x40,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF
	, 	0xFF,0x14,0x14,0x14,0x3A,0xC0,0x22,0x22,0xDD,0x20,0x22,0x20,0x04,0x44,0x42,0x83,0x7C,0x80,0x41,0x22,0x01,0x1E,0x40,0x30,0x48,0x24,0x12,0x12,0x24,0xC8,0x30,0xFF
	, 	0xFF,0x81,0x82,0x84,0x84,0x83,0x84,0x84,0x85,0x84,0x84,0x88,0xF0,0x83,0x81,0x81,0xC0,0xBE,0x89,0x93,0xA1,0xA0,0xA0,0x90,0x88,0x85,0x86,0x87,0x85,0x82,0x81,0xFF




};
unsigned char	bulb_f[] = {
	 	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x40,0x20,0x90,0x50,0x10,0x20,0x20,0x00,0x18,0x08,0x08,0x08,0x04,0x19,0x06,0x3C,0xC0,0x80,0x00,0x00,0x00
	, 	0x00,0x00,0x00,0xC0,0x2C,0x92,0x42,0x82,0x08,0x07,0x24,0x34,0x97,0xC4,0x6C,0x62,0x81,0x01,0x01,0xC2,0x9C,0x30,0x68,0x47,0x00,0x00,0x00,0x81,0x46,0x39,0x06,0xF8
	, 	0x10,0x38,0x46,0x89,0x8B,0x08,0x0B,0xB9,0xA8,0x28,0x28,0x28,0x29,0x3B,0x4F,0x84,0x84,0x07,0x08,0x00,0x80,0x10,0x8C,0x4E,0x11,0x0F,0x09,0x18,0x28,0xC6,0x03,0x01
	, 	0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x0F,0x01,0x12,0x12,0x24,0x24,0x24,0x28,0x68,0x89,0x99,0x49,0x38,0x0E,0x11,0x10,0x60,0xA0,0x80,0x80,0x40,0x31,0x0F,0x00
};
unsigned char bulb_b[]={
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	, 	0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0x38,0xC4,0x18,0x20,0x40,0x40,0x40,0xC0,0x40,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	, 	0x80,0x40,0x20,0xD8,0xD8,0x3C,0x07,0x00,0x07,0x78,0x80,0x00,0x00,0x00,0x00,0x01,0x00,0x02,0x02,0x05,0x05,0x19,0xE2,0x04,0xF8,0x04,0x02,0xA2,0xA2,0x5C,0x80,0x00
	, 	0x3F,0x40,0x9F,0x20,0x20,0x40,0x80,0x80,0x80,0x80,0x83,0x9C,0x9C,0xA0,0xC0,0x80,0x80,0xC0,0xC0,0xE0,0xE0,0x78,0x3F,0x06,0xA3,0xE0,0xE1,0x66,0x66,0x27,0x03,0x1C


};
unsigned char char_f[]={
 	0xF0,0x6C,0x80,0x02,0x01,0x01,0x01,0x01,0x41,0xE2,0x42,0x48,0x1C,0xF0,0x80,0x00,0xC1,0x82,0x8C,0x3C,0xE8,0x08,0x10,0x20,0xA2,0x22,0x40,0x80,0x00,0x38,0x1C,0x00
	, 	0x06,0x09,0x10,0x20,0x20,0x20,0xD0,0x48,0x70,0x38,0x08,0x84,0x40,0x03,0x0F,0x3C,0xE0,0xC1,0x03,0x00,0x1F,0x60,0x80,0x80,0x83,0x8F,0xFE,0xF0,0xC1,0x02,0x04,0xF8
	, 	0x00,0x18,0x24,0x32,0x22,0x1E,0x61,0x80,0x1C,0x13,0x09,0x10,0x10,0x08,0x7C,0x8E,0x01,0x01,0x03,0x07,0x8E,0x78,0x88,0x84,0x42,0x21,0x10,0x0F,0x03,0x01,0x01,0x00
	, 	0x00,0x00,0x00,0x00,0x00,0xE0,0xD0,0x90,0x89,0xC6,0x82,0x82,0x46,0x4C,0x34,0x04,0x03,0x3E,0x42,0x82,0x82,0xC7,0x8C,0x98,0xF0,0xA0,0x40,0x00,0x00,0x00,0x00,0x00


};
unsigned char char_b[]={
 	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	, 	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0xC0,0x60,0x20,0x20,0x20,0x20,0x20,0x20,0x40,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	, 	0x00,0x00,0x00,0x40,0x40,0x80,0x60,0x40,0x60,0x80,0xFE,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x81,0xC7,0xBF,0x38,0x20,0xC0,0xC0,0x00,0x00,0x00
	, 	0x00,0x00,0x00,0x00,0x00,0x07,0x9C,0x78,0x00,0x03,0x81,0x63,0x23,0x0E,0x00,0x04,0x1C,0x3C,0x0E,0x03,0x03,0x81,0xC1,0xE0,0x3B,0x1F,0x06,0x03,0x03,0x00,0x00,0x00


};
unsigned char sqr_f[]={
 	0x00,0x00,0xE0,0x10,0xCC,0x82,0x01,0x01,0x01,0x01,0xC1,0x81,0x01,0x02,0x04,0x18,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	, 	0x00,0x80,0x83,0x4C,0x50,0x6D,0x3C,0x3C,0xFC,0x2C,0x24,0x21,0x00,0x10,0x48,0x84,0x43,0x64,0xB8,0x40,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	, 	0xE3,0x14,0x14,0x14,0x3A,0xC0,0x22,0x22,0xDD,0x20,0x22,0x20,0x04,0x44,0x42,0x83,0x7C,0x80,0x41,0x22,0x01,0x1E,0x40,0x30,0x48,0x24,0x12,0x12,0x24,0xC8,0x30,0xC0
	, 	0x00,0x01,0x02,0x04,0x04,0x03,0x04,0x04,0x05,0x04,0x04,0x08,0x70,0x83,0x81,0x81,0x40,0x3E,0x09,0x13,0x21,0x20,0x20,0x10,0x08,0x05,0x06,0x07,0x05,0x02,0x01,0x00


};
unsigned char sqr_b[]={
 	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x40,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x40,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00
	, 	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x70,0x00,0x80,0x00,0x20,0x30,0x07,0xF8,0x00,0x00,0x00,0x00
	, 	0x00,0x00,0x00,0x00,0x00,0xC0,0x20,0xF0,0x48,0x48,0x28,0x34,0x0F,0x87,0x87,0x4F,0x34,0x34,0x24,0x38,0x48,0xF8,0xE0,0xF0,0x2B,0x2A,0x46,0x80,0x00,0x00,0x00,0x00
	, 	0x00,0x00,0x00,0x00,0x7F,0x80,0xBF,0x40,0xC0,0xC0,0xC0,0xE0,0x70,0xFF,0x80,0x80,0x80,0x80,0x80,0xC0,0xE0,0xF0,0xFF,0x7F,0x1C,0x1C,0x18,0x18,0x0F,0x00,0x00,0x00

};
typedef Pokemon* pm;
char pchp[16] = "                ";
char playername[16] ="                ";
char playerhp[16] ="                ";
char playermove[16] = "                ";
char effect[16]="                ";
int32_t mov_index=0;
int32_t rdm;
int8_t keyflag=0;
int cursorx=0;
int isPlayerTurn=1;
int iscount=0;
Pokemon player;
Pokemon pc;
pm pm1;
pm pm2;
mov charm_mov1={
"Scratch      N10",'N',10,
"N10      Scratch"
};
mov charm_mov2={
"Ember        F20",'F',20,
"F20        Ember"	
};
mov charm_mov3={
"Flamethrower F30",'F',30,
"F30 Flamethrower"
};
mov bulb_mov1={
"Tackle       N10",	'N',10,
	"N10       Tackle"
};
mov bulb_mov2={
"Razor Leaf   G20"
,'G',20,
	"G20   Razor Leaf"
};
mov bulb_mov3={
"Seed Bomb    G30",'G',30,
	"G30    Seed Bomb"
};
mov sqr_mov2={
"Water Gun    W20",'W',20,
	"W20    Water Gun"

};
mov sqr_mov3={

	"Hydro Pump   W30",'W',30,
	"W30   Hydro Pump"
};
Pokemon charm = {
    "Charmander",
    char_f,
		char_b,
    120,
		120,
		'F'
	
};
Pokemon bulbasaur = {
    "Bulbasaur",
    bulb_f,
		bulb_b,
    150,
		150,
		'G'
	
	
	
	
};
Pokemon Squirtle ={
	"Squirtle",
		sqr_f,
		sqr_b,
		110,
		110,
		'W'
	
	


};
 void Init_GPIO(void)
{
		
	  GPIO_SetMode(PC, BIT12, GPIO_MODE_OUTPUT); //????????? ???? 
	  GPIO_SetMode(PC, BIT13, GPIO_MODE_OUTPUT);
	  GPIO_SetMode(PC, BIT14, GPIO_MODE_OUTPUT);
	  GPIO_SetMode(PC, BIT15, GPIO_MODE_OUTPUT);
	
	  PC12=1; PC13=1; PC14=1; PC15=1;
}
// init keypad 
void Init_KEY(void){
	GPIO_SetMode(PA, BIT3, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PA, (BIT0|BIT1|BIT2|BIT3|BIT4|BIT5), GPIO_MODE_QUASI); 
	GPIO_EnableInt(PA, 2, GPIO_INT_FALLING); 
	GPIO_EnableInt(PA, 1, GPIO_INT_FALLING); 
	GPIO_EnableInt(PA, 0, GPIO_INT_FALLING); 
	NVIC_EnableIRQ(GPAB_IRQn); // interrupt group
	GPIO_SET_DEBOUNCE_TIME(GPIO_DBCLKSRC_LIRC, GPIO_DBCLKSEL_64); 
	GPIO_ENABLE_DEBOUNCE(PA, (BIT0|BIT1|BIT2));
	PA3 = 0; 
} 
void GPAB_IRQHandler(void){
	{
if (PA->ISRC & BIT0) {// check iPA0 interrupt 
	PA0=1;
PA->ISRC |= BIT0; // clear PA0 interrupt 
if (PA3==0) { keyflag =3; PA3=1; }
if (PA4==0) { keyflag =6; PA4=1;}
if (PA5==0) { keyflag =9; PA5=1;}

}
if (PA->ISRC & BIT1) {	
	PA1=1;
PA->ISRC |= BIT1; 
if (PA3==0) { keyflag =2; PA3=1;}
if (PA4==0) { keyflag =5; PA4=1;}
if (PA5==0) { keyflag =8; PA5=1;} 

}
if (PA->ISRC & BIT2) {
PA->ISRC |= BIT2;
		PA2=1;
if (PA3==0) { keyflag =1; PA3=1;}
if (PA4==0) { keyflag =4; PA4=1;}
if (PA5==0) { keyflag =7; PA5=1;}
		
} return;		
}
PA->ISRC = PA->ISRC; // clear all GPB pins
}

volatile uint32_t index_5ms, cnt_5ms, cnt_1s, cnt_100ms,index_key_scan;
int32_t battle_count_down=10;
void TMR1_IRQHandler(void)
{	
	
	srand(cnt_5ms);
	cnt_5ms++;
	index_5ms = cnt_5ms % 4;

	CloseSevenSegment();
	if (index_5ms == 0) {			
	//ShowSevenSegment(0,digit[0]);				
	}	
	if (index_5ms == 1)  {
	//ShowSevenSegment(1,digit[1]);		
	}	
	if (index_5ms == 2)  {
		if(iscount&&battle_count_down/10!=0)
			ShowSevenSegment(1,battle_count_down/10);		
	}
	if (index_5ms == 3)  {
		if(iscount)
	ShowSevenSegment(0,battle_count_down%10);
	}		
	
	if (cnt_5ms % 20 == 0) 
	{
		cnt_100ms++;
		index_key_scan = cnt_100ms++ % 3;
		if (index_key_scan == 0)
		{
			PA0=1; PA1=1; PA2=1; PA3=1; PA4=1; PA5=0;
		}
		if (index_key_scan == 1)
		{
			PA0=1; PA1=1; PA2=1; PA3=1; PA4=0; PA5=1;
		}
		if (index_key_scan == 2)
		{
			PA0=1; PA1=1; PA2=1; PA3=0; PA4=1; PA5=1;
		}
		
		NVIC_EnableIRQ(GPAB_IRQn);
	}
	
	if (cnt_5ms % 200 == 0) cnt_1s++;	

  TIMER_ClearIntFlag(TIMER1); // Clear Timer1 time-out interrupt flag
}
void player_switch(){
	isPlayerTurn=!isPlayerTurn;

}
void TMR0_IRQHandler(void) //do when catch tmr0 interrupt
{	
	if(battle_count_down!=0){
	//	PD12=0;
	battle_count_down--;
	}
	else{
		
		isPlayerTurn=0;
	}
	
  TIMER_ClearIntFlag(TIMER0); // Clear Timer1 time-out interrupt flag
	//need to leave this kind of interrupt
	
}

void Init_Timer0(void) //battle timer
{
  TIMER_Open(TIMER0, TMR0_OPERATING_MODE, TMR0_OPERATING_FREQ);// set timer configuration
  TIMER_EnableInt(TIMER0);// this timer can throw interrupt
  NVIC_EnableIRQ(TMR0_IRQn); //NVIC can catch this interrupt
  
}
void Init_Timer1(void)
{
  TIMER_Open(TIMER1, TIMER_PERIODIC_MODE, 200);
  TIMER_EnableInt(TIMER1);
  NVIC_EnableIRQ(TMR1_IRQn);
  TIMER_Start(TIMER1);
}

void draw_Bmp_axb(int16_t x, int16_t y, uint16_t fgColor, uint16_t bgColor, unsigned char bitmap[], uint8_t a, uint8_t b) {
    uint8_t t, i, j, k, kx, ky;
    uint8_t bytes_per_col = (b + 7) / 8; 

    if (x < (LCD_Xmax - (a - 1)) && y < (LCD_Ymax - (b - 1))) {
        for (j = 0; j < bytes_per_col; j++) {
            for (i = 0; i < a; i++) {        
                kx = x + i;                 
                t = bitmap[i + j * a];      

                
                for (k = 0; k < 8; k++) {   
                    ky = y + j * 8 + k;    
                    if (ky >= y + b) break; 
                    if (t & (0x01 << k))    
                        draw_Pixel(kx, ky, fgColor, bgColor); 
                }
            }
        }
    }
}
void print_Line5x7(int8_t line, char text[])
{
	int8_t i;
	for (i=0;i<strlen(text);i++) 
		printC_5x7(i*8,line*11,text[i]);
}
void print_last_line(char text[])
{
	int8_t i;
	for (i=0;i<strlen(text);i++) 
		printC_5x7(i*8,56,text[i]);
}





void  Init_PMmov(){
	charm.movearr[0]=charm_mov1;
	charm.movearr[1]=charm_mov2;
	charm.movearr[2]=charm_mov3;
	bulbasaur.movearr[0]=bulb_mov1;
	bulbasaur.movearr[1]=bulb_mov2;
	bulbasaur.movearr[2]=bulb_mov3;
	Squirtle.movearr[0]=bulb_mov1;
	Squirtle.movearr[1]=sqr_mov2;
	Squirtle.movearr[2]=sqr_mov3;
}
float damage_ratio(pm attacker,pm defender){
	if(attacker->movearr[mov_index].type=='N'){
		sprintf(effect,"                     ");
		return 1;
	}
	if((attacker->movearr[mov_index].type=='F'&&defender->type=='G')||(attacker->movearr[mov_index].type=='W'&&defender->type=='F')||(attacker->movearr[mov_index].type=='G'&&defender->type=='W')){
		sprintf(effect,"Super effective!");
		return 2;
	}
	else{
		sprintf(effect,"Not effective!");
		return 0.5;
	}
	return 1;
}
int i=0;
void attacker_moving(pm attacker){
	clear_LCD();
	
	if(attacker==&player){
		print_last_line(player.movearr[mov_index].left_name);
		for(i=0;i<5;i++){
		draw_Bmp_axb(0,20,0,0,player.back_bmp,32,32);
		draw_Bmp_axb(5,20,1,0,player.back_bmp,32,32);
		CLK_SysTickDelay(250000);
		draw_Bmp_axb(5,20,0,0,player.back_bmp,32,32);
		draw_Bmp_axb(0,20,1,0,player.back_bmp,32,32);
		CLK_SysTickDelay(250000);
		}
	}
	else{
		print_last_line(pc.movearr[mov_index].right_name);
		for(i=0;i<5;i++){
		draw_Bmp_axb(95,0,0,0,pc.front_bmp,32,32);
		draw_Bmp_axb(90,0,1,0,pc.front_bmp,32,32);
		CLK_SysTickDelay(250000);
		draw_Bmp_axb(90,0,0,0,pc.front_bmp,32,32);
		draw_Bmp_axb(95,0,1,0,pc.front_bmp,32,32);
		CLK_SysTickDelay(250000);
	}
}
	}
void defender_shine(pm defender){
		print_Line5x7(0,effect);
		if(defender==&player){
		for(i=0;i<4;i++){
			draw_Bmp_axb(0,20,1,0,player.back_bmp,32,32);
			CLK_SysTickDelay(250000);
			draw_Bmp_axb(0,20,0,0,player.back_bmp,32,32);
			CLK_SysTickDelay(250000);
		}
	}
	else{
		for(i=0;i<4;i++){
			draw_Bmp_axb(95,0,1,0,pc.front_bmp,32,32);
			CLK_SysTickDelay(250000);
			draw_Bmp_axb(95,0,0,0,pc.front_bmp,32,32);
			CLK_SysTickDelay(250000);
	}
		
	}
		sprintf(effect,"                     ");
		print_Line5x7(0,effect);
}

void login_page(){
	draw_Bmp_axb(0,15,1,0,bulb_f,32,32);
	draw_Bmp_axb(40,15,1,0,char_f,32,32);
	draw_Bmp_axb(80,15,1,0,sqr_f,32,32);
	draw_Bmp_axb(cursorx,15,1,0,bulb_frame,32,32);

}
void select_PM_page(){
	if(keyflag==4&&cursorx==40){
			draw_Bmp_axb(cursorx,15,0,0,char_frame,32,32);
			draw_Bmp_axb(cursorx,15,1,0,char_f,32,32);
			cursorx=cursorx-40;
			draw_Bmp_axb(cursorx,15,1,0,bulb_frame,32,32);
			player=bulbasaur;
			printC(0,48,keyflag+'0');
			keyflag=0;
		}
		if(keyflag==4&&cursorx==80){
			draw_Bmp_axb(cursorx,15,0,0,sqr_frame,32,32);
			draw_Bmp_axb(cursorx,15,1,0,sqr_f,32,32);
			cursorx=cursorx-40;
			draw_Bmp_axb(cursorx,15,1,0,char_frame,32,32);
				player=charm;
			printC(0,48,keyflag+'0');
			keyflag=0;
		}
		if(keyflag==6&&cursorx==0){
			draw_Bmp_axb(cursorx,15,0,0,bulb_frame,32,32);
			draw_Bmp_axb(cursorx,15,1,0,bulb_f,32,32);
			cursorx+=40;
			draw_Bmp_axb(cursorx,15,1,0,char_frame,32,32);
			player=charm;
		//	printC(0,48,'8');
			keyflag=0;
		}
		
		if(keyflag==6&&cursorx==40){
			draw_Bmp_axb(cursorx,15,0,0,char_frame,32,32);
			draw_Bmp_axb(cursorx,15,1,0,char_f,32,32);
			cursorx+=40;
			draw_Bmp_axb(cursorx,15,1,0,sqr_frame,32,32);
			player=Squirtle;
			//printC(0,48,'9');
			keyflag=0;
		}

}
void Now_battle_page(){
		print_Line5x7(0,pc.name);
		sprintf(pchp,"HP:%d/%d>",pc.hp,pc.fixhp);
		print_Line5x7(1,pchp);
		draw_Bmp_axb(128-33,0,1,0,pc.front_bmp,32,32);
		sprintf(playername,"      %s",player.name);
		print_Line5x7(3,playername);
		sprintf(playerhp,"     <HP:%d/%d",player.hp,player.fixhp);
		print_Line5x7(4,playerhp);
		draw_Bmp_axb(0,20,1,0,player.back_bmp,32,32);}
int main(void)
{
	SYS_Init();
	Init_KEY();
	Init_PMmov();
	Init_GPIO();
	init_LCD();

	Init_Timer0();
	Init_Timer1();
	clear_LCD();
	
	player=bulbasaur;
	login_page();
	while(keyflag!=5){
		
	select_PM_page();
	
	
	}
	clear_LCD();
	
	rdm=rand();
	if(rdm%3==1){
		 pc = bulbasaur;}
	if(rdm%3==0){
		pc = charm;}
	if(rdm%3==2){
	  pc = Squirtle;}

		
	
		
		pm1=&pc;
		pm2=&player;
		keyflag=0;
		Now_battle_page();
		print_last_line(player.movearr[mov_index].left_name);
		
  while(1){
		
		Now_battle_page();
		
//printC(16,16,'8');	
		//printC(16,16,mov_index-'0');
			if(keyflag==6&&mov_index<2){
				PD12=0;
				mov_index++;
				keyflag=0;
			//	print_last_line("                ");
		print_last_line(player.movearr[mov_index].left_name);
			
			}
			if(keyflag==4&&mov_index>0){
				
				mov_index--;
				keyflag=0;
				//	print_last_line("                ");
				print_last_line(player.movearr[mov_index].left_name);
			}
		
			if(isPlayerTurn){
				if(battle_count_down==10){
					iscount=1;
					TIMER_Start(TIMER0);
				}
					if(keyflag==5){
					//	iscount=0;
						TIMER_Stop(TIMER0);
						pc.hp=	pc.hp-(mov_index+1)*10*damage_ratio(pm2,pm1);
						
						attacker_moving(pm2);
						defender_shine(pm1);
						

						print_Line5x7(1,"              ");
						sprintf(pchp,"HP:%d/%d>",pc.hp,pc.fixhp);
					//	print_Line5x7(1,pchp);
						Now_battle_page();
						player_switch();
						CLK_SysTickDelay(1000000);
						keyflag=0;
					}
				}
			if(!isPlayerTurn){
				CLK_SysTickDelay(1000000);
				rdm=rand();
				mov_index=rdm%3;
				player.hp=	player.hp-(mov_index+1)*10*damage_ratio(pm1,pm2);
				attacker_moving(pm1);
				defender_shine(pm2);
				
				
				
				print_Line5x7(4,"                 ");
				sprintf(playerhp,"     <HP:%d/%d",player.hp,player.fixhp);
				//print_Line5x7(4,playerhp);
				Now_battle_page();
				
				player_switch();
				battle_count_down=10;
				print_last_line(player.movearr[mov_index].left_name);
			}
		
			
		
		
		
		
	
		if(pc.hp<=0){
			clear_LCD();
			draw_Bmp_axb(40,15,1,0,player.front_bmp,32,32);
			print_last_line("player  win!          ");
			CloseSevenSegment();
			return 1;
			
		}
		if(player.hp<=0){
			clear_LCD();
			draw_Bmp_axb(40,15,1,0,pc.front_bmp,32,32);
			print_last_line("PC  win!          ");
				CloseSevenSegment();
			return 1;
		}
			
			
	};// must exist!
}

